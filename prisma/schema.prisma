generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_DIRECT")
}

enum TipoGasto {
  FIXO
  VARIAVEL
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Membro {
  id               String                 @id @default(cuid())
  nome             String
  grau             String
  status           String
  
  cim              String?
  cargo            String?
  assinaturaUrl    String?
  
  dataIniciacao    String?
  dataFiliacao     String?
  dataPassagemGrau String?
  dataElevacao     String?
  dataInstalacao   String?
  
  dataCadastro     DateTime               @default(now())
  
  pagamentos       PagamentoMensalidade[]
  
  @@map("membros")
}

model PlanilhaFinanceira {
  id                      String    @id @default(cuid())
  mes                     Int       // 1-12
  ano                     Int
  valorMensalidade        Decimal   @db.Decimal(10, 2)
  valorMensalidadeExcecao Decimal?  @db.Decimal(10, 2)
  membrosExcecaoIds       String?   // IDs separados por vírgula
  inadimplenciaPorMembro  Json?     // { "membroId": [{ mes: 12, ano: 2024 }] }
  
  // Saldos de Caixa
  saldoInicialCaixa       Decimal   @db.Decimal(10, 2)
  saldoFinalCaixa         Decimal   @db.Decimal(10, 2)
  totalReceitas           Decimal   @default(0) @db.Decimal(10, 2) // Alias para totalRecebidoCaixa
  totalDespesas           Decimal   @default(0) @db.Decimal(10, 2)
  
  // Saldos de Tronco
  saldoInicialTronco      Decimal   @db.Decimal(10, 2)
  saldoFinalTronco        Decimal   @db.Decimal(10, 2)
  totalTroncoRecebido     Decimal   @default(0) @db.Decimal(10, 2)
  totalDoacoesFilantropicas Decimal @default(0) @db.Decimal(10, 2)
  
  // Saldo Total Geral (Caixa + Tronco)
  saldoFinal              Decimal   @default(0) @db.Decimal(10, 2)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  receitas                Receita[]
  despesas                Despesa[]
  pagamentos              PagamentoMensalidade[]
  troncos                 Tronco[]
  doacoesFilantropicas    DoacaoFilantropica[]

  @@unique([mes, ano])
  @@map("planilhas_financeiras")
}

model PagamentoMensalidade {
  id               String             @id @default(cuid())
  planilhaId       String
  membroId         String
  quantidadeMeses  Int                // Pode ser negativo para inadimplências
  valorPago        Decimal            @db.Decimal(10, 2)
  mesesReferentes  String             // Ex: "JAN/24, FEV/24"
  dataPagamento    DateTime           @default(now())
  
  planilha         PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)
  membro           Membro             @relation(fields: [membroId], references: [id], onDelete: Cascade)

  @@map("pagamentos_mensalidade")
}

model Receita {
  id          String             @id @default(cuid())
  planilhaId  String
  descricao   String
  valor       Decimal            @db.Decimal(10, 2)
  data        DateTime           @default(now())
  
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("receitas")
}

model Despesa {
  id          String             @id @default(cuid())
  planilhaId  String
  descricao   String
  valor       Decimal            @db.Decimal(10, 2)
  categoria   String             // DESPESAS DE CUSTEIO, etc
  tipoGasto   TipoGasto          // FIXO ou VARIAVEL (enum)
  data        DateTime           @default(now())
  
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("despesas")
}

model Tronco {
  id          String             @id @default(cuid())
  planilhaId  String
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)
  grauSessao  String
  data        DateTime           @default(now())
  dataDeposito DateTime          @default(now())
  valor       Decimal            @db.Decimal(10, 2)
  
  @@map("tronco_beneficencia")
}

model DoacaoFilantropica {
  id            String             @id @default(cuid())
  planilhaId    String
  descricao     String
  valor         Decimal            @db.Decimal(10, 2)
  dataPagamento DateTime           @default(now())
  
  planilha      PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("doacoes_filantropicas")
}