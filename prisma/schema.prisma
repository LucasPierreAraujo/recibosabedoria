generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

enum TipoGasto {
  FIXO
  VARIAVEL
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Membro {
  id               String                 @id @default(cuid())
  nome             String
  grau             String
  status           String

  cim              String?
  cargo            String?
  assinaturaUrl    String?

  dataIniciacao    String?
  dataFiliacao     String?
  dataPassagemGrau String?
  dataElevacao     String?
  dataInstalacao   String?

  dataCadastro     DateTime               @default(now())

  pagamentos       PagamentoMensalidade[]
  atasCargos       AtaCargo[]
  atasPresencas    AtaPresenca[]
  presencas        Presenca[]

  @@map("membros")
}

model PlanilhaFinanceira {
  id                      String    @id @default(cuid())
  mes                     Int       // 1-12
  ano                     Int
  valorMensalidade        Decimal   @db.Decimal(10, 2)
  valorMensalidadeExcecao Decimal?  @db.Decimal(10, 2)
  membrosExcecaoIds       String?   // IDs separados por vírgula
  inadimplenciaPorMembro  Json?     // { "membroId": [{ mes: 12, ano: 2024 }] }
  
  // Saldos de Caixa
  saldoInicialCaixa       Decimal   @db.Decimal(10, 2)
  saldoFinalCaixa         Decimal   @db.Decimal(10, 2)
  totalReceitas           Decimal   @default(0) @db.Decimal(10, 2) // Alias para totalRecebidoCaixa
  totalDespesas           Decimal   @default(0) @db.Decimal(10, 2)
  
  // Saldos de Tronco
  saldoInicialTronco      Decimal   @db.Decimal(10, 2)
  saldoFinalTronco        Decimal   @db.Decimal(10, 2)
  totalTroncoRecebido     Decimal   @default(0) @db.Decimal(10, 2)
  totalDoacoesFilantropicas Decimal @default(0) @db.Decimal(10, 2)
  
  // Saldo Total Geral (Caixa + Tronco)
  saldoFinal              Decimal   @default(0) @db.Decimal(10, 2)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  receitas                Receita[]
  despesas                Despesa[]
  pagamentos              PagamentoMensalidade[]
  troncos                 Tronco[]
  doacoesFilantropicas    DoacaoFilantropica[]

  @@unique([mes, ano])
  @@map("planilhas_financeiras")
}

model PagamentoMensalidade {
  id               String             @id @default(cuid())
  planilhaId       String
  membroId         String
  quantidadeMeses  Int                // Pode ser negativo para inadimplências
  valorPago        Decimal            @db.Decimal(10, 2)
  mesesReferentes  String             // Ex: "JAN/24, FEV/24"
  dataPagamento    DateTime           @default(now())
  
  planilha         PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)
  membro           Membro             @relation(fields: [membroId], references: [id], onDelete: Cascade)

  @@map("pagamentos_mensalidade")
}

model Receita {
  id          String             @id @default(cuid())
  planilhaId  String
  descricao   String
  valor       Decimal            @db.Decimal(10, 2)
  data        DateTime           @default(now())
  
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("receitas")
}

model Despesa {
  id          String             @id @default(cuid())
  planilhaId  String
  descricao   String
  valor       Decimal            @db.Decimal(10, 2)
  categoria   String             // DESPESAS DE CUSTEIO, etc
  tipoGasto   TipoGasto          // FIXO ou VARIAVEL (enum)
  data        DateTime           @default(now())
  
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("despesas")
}

model Tronco {
  id          String             @id @default(cuid())
  planilhaId  String
  planilha    PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)
  grauSessao  String
  data        DateTime           @default(now())
  dataDeposito DateTime          @default(now())
  valor       Decimal            @db.Decimal(10, 2)
  
  @@map("tronco_beneficencia")
}

model DoacaoFilantropica {
  id            String             @id @default(cuid())
  planilhaId    String
  descricao     String
  valor         Decimal            @db.Decimal(10, 2)
  dataPagamento DateTime           @default(now())
  
  planilha      PlanilhaFinanceira @relation(fields: [planilhaId], references: [id], onDelete: Cascade)

  @@map("doacoes_filantropicas")
}

// Adicione estes modelos ao seu schema.prisma existente
// IMPORTANTE: Os modelos AtaCargo e AtaPresenca têm campo nomeManual para aceitar digitação manual

model Ata {
  id                    String   @id @default(cuid())
  numeroAta             String   @unique // ex: "33/2025"
  livro                 String   // "APRENDIZ", "COMPANHEIRO", "MESTRE"
  data                  DateTime
  horarioInicio         String   // ex: "19:45"
  horarioEncerramento   String   // ex: "22:20"
  numeroPresentes       Int
  valorTronco           Decimal  @db.Decimal(10, 2)
  
  // Conteúdo da ata em formato texto
  leituraAta            String?  @db.Text
  expediente            String?  @db.Text
  ordemDia              String?  @db.Text
  coberturaTemplo       String?  @db.Text
  palavraBemLoja        String?  @db.Text
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  cargos                AtaCargo[]
  presencas             AtaPresenca[]
  
  @@map("atas")
}

model AtaCargo {
  id          String  @id @default(cuid())
  ataId       String
  ata         Ata     @relation(fields: [ataId], references: [id], onDelete: Cascade)
  
  cargo       String  // ex: "Venerável Mestre", "1° Vigilante"
  
  // Pode ser um membro cadastrado OU um nome digitado manualmente
  membroId    String?
  membro      Membro? @relation(fields: [membroId], references: [id])
  nomeManual  String? // Nome digitado manualmente (se não for membro cadastrado)
  
  @@map("atas_cargos")
}

model AtaPresenca {
  id          String  @id @default(cuid())
  ataId       String
  ata         Ata     @relation(fields: [ataId], references: [id], onDelete: Cascade)

  // Pode ser um membro cadastrado OU um nome digitado manualmente
  membroId    String?
  membro      Membro? @relation(fields: [membroId], references: [id])
  nomeManual  String? // Nome digitado manualmente (se não for membro cadastrado)

  tipo        String  // "QUADRO" ou "VISITANTE"

  @@map("atas_presencas")
}

// Controle de Mensalidades
model ControleMensalidade {
  id        String @id @default(cuid())
  ano       Int
  membroId  String
  mes       String // JAN, FEV, MAR, etc
  status    String // ok, x, p, i

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ano, membroId, mes])
  @@map("controle_mensalidades")
}

model ConfiguracaoMensalidade {
  id               String @id @default(cuid())
  ano              Int
  mes              String // JAN, FEV, MAR, etc
  valorMensalidade String
  valorParcial     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ano, mes])
  @@map("configuracao_mensalidades")
}

// Modelos para controle de presença em reuniões
model Reuniao {
  id        String     @id @default(cuid())
  data      DateTime
  grau      String     // "APRENDIZ", "COMPANHEIRO", "MESTRE"

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  presencas Presenca[]

  @@map("reunioes")
}

model Presenca {
  id        String   @id @default(cuid())
  reuniaoId String
  membroId  String
  presente  Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reuniao   Reuniao  @relation(fields: [reuniaoId], references: [id], onDelete: Cascade)
  membro    Membro   @relation(fields: [membroId], references: [id], onDelete: Cascade)

  @@unique([reuniaoId, membroId])
  @@map("presencas")
}

// Adicione estas relações ao modelo Membro existente:
// model Membro {
//   ...
//   atasCargos    AtaCargo[]
//   atasPresencas AtaPresenca[]
//   presencas     Presenca[]
// }